/*
 * mfcc.c
 *
 *  Created on: 22.01.2019
 *      Author: piotr
 */

#include"mfcc.h"

arm_rfft_fast_instance_f32 S; //FFT
arm_rfft_instance_f32 S2; //Do DCT
arm_dct4_instance_f32 D; //DCT
arm_cfft_radix4_instance_f32 C; //DCT

float32_t dctState[CEPLENGTH + CEPLENGTH];

void mfcc_init()
{
	arm_rfft_fast_init_f32(&S,BLOCK_SIZE);
	//arm_cfft_radix4_init_f32(&C,128,0,0.125);
	//arm_dct4_init_f32(&D,&S2,&C,128,10,0.125);//D,S,C, length of the DCT, half of the length of DCT,normalizing factor
	//arm_dct4_init_f32 inicjalizuje wewnatrz swoja instancje fft
	//The normalizing factor is sqrt(2/N), which depends on the size of transform N.
	//dct niby wspiera lugosci 20148, 512,128
	//~piotr - zmienilem funkcje w dct z fft na fft_fast (te nowsza) i ona wspiera dlugosci 32+ (potegi 2)
	//^jednak nie ~piotr
	//dla 32 normalizing factor to 0.25
	//dla 128 jest 0.125
}

//output musi byc wyzerowany
void mfcc(uint16_t *input1,float32_t *output)
{

	float32_t input[BLOCK_SIZE];

	for(uint16_t p = 0;p<BLOCK_SIZE;++p)
	{
		input[p]=(float32_t)input1[p];
	}

	float32_t fftout[BLOCK_SIZE];

const float32_t hamming[BLOCK_SIZE]=
{
		0.0800000000000000, 0.0801396320901791,
		0.0805584435906266, 0.0812561802425375, 0.0822324184527504,
		0.0834865655509096, 0.0850178601492729, 0.0868253726049470,
		0.0889080055842703, 0.0912644947289992, 0.0938934094238956,
		0.0967931536652478, 0.0999619670297972, 0.103397925743485,
		0.107098943849369, 0.111062774473996, 0.115287011191475,
		0.119769089484404, 0.124506288300781, 0.129495731705944,
		0.134734390628539, 0.140219084699457, 0.145946484182623,
		0.151913111996467, 0.158115345824847, 0.164549420316138,
		0.171211429369169, 0.178097328504598, 0.185202937320297,
		0.192523942029263, 0.200055898078497, 0.207794232847276,
		0.215734248423172, 0.223871124454139, 0.232199921074925,
		0.240715581906049, 0.249412937123505, 0.258286706597345,
		0.267331503097225, 0.276541835562968, 0.285912112438167,
		0.295436645064799, 0.305109651136783, 0.314925258210395,
		0.324877507269410, 0.334960356342792, 0.345167684172755,
		0.355493293930949, 0.365930916980537, 0.376474216681854,
		0.387116792239357, 0.397852182587524, 0.408673870313343,
		0.419575285613002, 0.430549810280395, 0.441590781725011,
		0.452691497016760, 0.463845216955300, 0.475045170161378,
		0.486284557187706, 0.497556554646881, 0.508854319353835,
		0.520170992480304, 0.531499703718800, 0.542833575453544,
		0.554165726935838, 0.565489278461346, 0.576797355546729,
		0.588083093103121, 0.599339639603894, 0.610560161244195,
		0.621737846089724, 0.632865908212225, 0.643937591809204,
		0.654946175305346, 0.665884975433158, 0.676747351290353,
		0.687526708371517, 0.698216502571607, 0.708810244158849,
		0.719301501714633, 0.729683906037996, 0.739951154012344,
		0.750097012432047, 0.760115321786592, 0.770000000000000,
		0.779745046123229, 0.789344543977327, 0.798792665745119,
		0.808083675509254, 0.817211932734458, 0.826171895691878,
		0.834958124823446, 0.843565286044212, 0.851988153980648,
		0.860221615142946, 0.868260671029406, 0.876100441160999,
		0.883736166044290, 0.891163210060908, 0.898377064281809,
		0.905373349204632, 0.912147817412476, 0.918696356152490,
		0.925014989832710, 0.931099882435623, 0.936947339846999,
		0.942553812098577, 0.947915895523229, 0.953030334821319,
		0.957894025036981, 0.962504013443125, 0.966857501334024,
		0.970951845724403, 0.974784560953977, 0.978353320196492,
		0.981655956872329, 0.984690465963826, 0.987455005232518,
		0.989947896337551, 0.992167625854595, 0.994112846194642,
		0.995782376422118, 0.997175202971826, 0.998290480264278,
		0.999127531219040, 0.999685847665791, 0.999965090652822,
		0.999965090652822, 0.999685847665791, 0.999127531219040,
		0.998290480264278, 0.997175202971826, 0.995782376422118,
		0.994112846194642, 0.992167625854595, 0.989947896337551,
		0.987455005232518, 0.984690465963826, 0.981655956872329,
		0.978353320196492, 0.974784560953977, 0.970951845724403,
		0.966857501334024, 0.962504013443125, 0.957894025036981,
		0.953030334821319, 0.947915895523229, 0.942553812098577,
		0.936947339846999, 0.931099882435623, 0.925014989832710,
		0.918696356152490, 0.912147817412476, 0.905373349204632,
		0.898377064281809, 0.891163210060908, 0.883736166044290,
		0.876100441160999, 0.868260671029406, 0.860221615142946,
		0.851988153980648, 0.843565286044212, 0.834958124823446,
		0.826171895691878, 0.817211932734458, 0.808083675509254,
		0.798792665745119, 0.789344543977327, 0.779745046123229,
		0.770000000000000, 0.760115321786592, 0.750097012432047,
		0.739951154012344, 0.729683906037996, 0.719301501714633,
		0.708810244158849, 0.698216502571607, 0.687526708371517,
		0.676747351290353, 0.665884975433158, 0.654946175305346,
		0.643937591809204, 0.632865908212225, 0.621737846089724,
		0.610560161244195, 0.599339639603894, 0.588083093103121,
		0.576797355546729, 0.565489278461346, 0.554165726935838,
		0.542833575453544, 0.531499703718800, 0.520170992480304,
		0.508854319353835, 0.497556554646881, 0.486284557187706,
		0.475045170161378, 0.463845216955300, 0.452691497016760,
		0.441590781725011, 0.430549810280395, 0.419575285613002,
		0.408673870313343, 0.397852182587524, 0.387116792239357,
		0.376474216681854, 0.365930916980537, 0.355493293930949,
		0.345167684172755, 0.334960356342792, 0.324877507269410,
		0.314925258210395, 0.305109651136783, 0.295436645064799,
		0.285912112438167, 0.276541835562968, 0.267331503097225,
		0.258286706597345, 0.249412937123505, 0.240715581906049,
		0.232199921074925, 0.223871124454139, 0.215734248423172,
		0.207794232847276, 0.200055898078497, 0.192523942029263,
		0.185202937320297, 0.178097328504598, 0.171211429369169,
		0.164549420316138, 0.158115345824847, 0.151913111996467,
		0.145946484182623, 0.140219084699457, 0.134734390628539,
		0.129495731705944, 0.124506288300781, 0.119769089484404,
		0.115287011191475, 0.111062774473996, 0.107098943849369,
		0.103397925743485, 0.0999619670297972, 0.0967931536652478,
		0.0938934094238956, 0.0912644947289992, 0.0889080055842703,
		0.0868253726049470, 0.0850178601492729, 0.0834865655509096,
		0.0822324184527504, 0.0812561802425375, 0.0805584435906266,
		0.0801396320901791, 0.0800000000000000
};

//Hamming window windowing
for(uint16_t i=0;i<BLOCK_SIZE;i++)
{
	input[i]=input[i]*hamming[i];
}

//FFT
arm_rfft_fast_f32(&S,input,fftout,0);

uint8_t posbank;
uint8_t posFFT;

const uint8_t positionbank[CEPLENGTH]={0,4,9,14,19,26,33,40,49,59,69,80,92,105,119,135,153,172,193,215};
const uint8_t positionFFT[CEPLENGTH]={1,3,5,8,10,13,18,20,24,29,34,39,45,51,58,64,74,83,93,104};
const uint8_t length[CEPLENGTH]={4,5,5,5,7,7,7,9,10,10,11,12,13,14,16,18,19,21,22,24};
const float32_t melbank[239]={0.963300382814376,1.8862832885653,1.22781156861115,0.376119929469339,0.772188431388852,1.62388007053066,1.55609712507763,0.765472230911834,0.00221015798720448,
0.443902874922372,1.23452776908817,1.9977898420128,1.26448008715061,0.55062901401357,
0.735519912849392,1.44937098598643,1.85915944266599,1.18871047110327,0.53804166772796,
0.140840557334013,0.811289528896731,1.46195833227204,1.9060192588325,1.29160424063534,0.693842102788338,0.111853908128497,
0.0939807411674956,0.708395759364656,1.30615789721166,1.8881460918715,1.54482851939697,0.992015800380493,0.452720648474299,
0.455171480603031,1.00798419961951,1.5472793515257,1.9262977395658,1.41214688557969,0.909708920922187,0.418462047125516,
0.0737022604341959,0.587853114420312,1.09029107907781,1.58153795287448,1.93791857577935,1.46762201878117,1.0071444823884,0.55608432778595,0.114064066115706,
0.0620814242206507,0.532377981218829,0.992855517611602,1.44391567221405,1.88593593388429,1.68072846032292,1.25574280990489,0.838791397812084,0.429576081447497,0.0278150120127201,
0.319271539677079,0.744257190095105,1.16120860218792,1.5704239185525,1.97218498798728,1.63324146842178,1.24560279369966,0.864659423243193,0.490183995585042,0.121960537395204,
0.366758531578217,0.754397206300336,1.13534057675681,1.50981600441496,1.8780394626048,1.75978371540472,1.40345814876384,1.05279777606893,0.70762527192402,0.367771508457036,0.0330750576970011,
0.240216284595284,0.596541851236157,0.947202223931072,1.29237472807598,1.63222849154296,1.966924942303,1.70338173114709,1.37854415326632,1.05842136590656,0.742878461047557,0.431786239434704,0.125020892958005,
0.29661826885291,0.621455846733685,0.941578634093439,1.25712153895244,1.5682137605653,1.87497910704199,1.82246370881778,1.52400079370819,1.22952281641469,0.938924767369784,0.652105733843662,0.368968689565421,0.0894202976774032,
0.177536291182218,0.47599920629181,0.770477183585314,1.06107523263022,1.34789426615634,1.63103131043458,1.9105797023226,1.81337072602128,1.54073347384125,1.27142520906776,1.00536561541613,0.742477248597723,0.482685401000122,0.225917974244201,
0.186629273978717,0.459266526158753,0.728574790932235,0.994634384583872,1.25752275140228,1.51731459899988,1.7740820257558,1.97210535907463,1.72118032208284,1.47307789880158,1.22773529274555,0.985091780005721,0.745088619034764,0.507668965288129,0.272777790410721,0.0403618056815063,
0.0278946409253713,0.278819677917159,0.526922101198416,0.77226470725445,1.01490821999428,1.25491138096524,1.49233103471187,1.72722220958928,1.95963819431849,1.81036938944985,1.58275051831626,1.35745670182816,1.13444092047726,0.913657566800382,0.695062389399183,0.478612439706723,0.264266021340845,0.0519826418950444,
0.189630610550154,0.41724948168374,0.642543298171837,0.86555907952274,1.08634243319962,1.30493761060082,1.52138756029328,1.73573397865916,1.94801735810496,1.84172296702719,1.63344877671603,1.42712292356389,1.22270929303154,1.02017276549902,0.819479180052518,0.620595299904089,0.423488779356546,0.228128132231411,0.0344827016828972,
0.158277032972812,0.36655122328397,0.572877076436114,0.777290706968458,0.979827234500981,1.18052081994748,1.37940470009591,1.57651122064345,1.77187186776859,1.9655172983171,1.84252263132557,1.65221883760751,1.46354298336529,1.27646745250041,1.09096532572068,0.90701035729338,0.724576952759648,0.543640147563202,0.36417558654842,0.186159504285854,0.00956870618536954,
0.157477368674428,0.347781162392494,0.536457016634707,0.723532547499595,0.909034674279319,1.09298964270662,1.27542304724035,1.4563598524368,1.63582441345158,1.81384049571415,1.99043129381463,1.83438055035939,1.66057293020076,1.48812425764173,1.3170134470623,1.14721989981805,0.978723489358899,0.811504546911998,0.645543847703365,0.480822597693923,0.317322420807258,0.155025346627248,
0.165619449640609,0.339427069799235,0.511875742358271,0.682986552937699,0.852780100181946,1.0212765106411,1.188495453088,1.35445615229663,1.51917740230608,1.68267757919274,1.84497465337275,1.99391379854507,1.83397058233596,1.67517887514716,1.51752221487955,1.36098448994592,1.2055499293903,1.05120309335296,0.897928863866639,0.745712435970518,0.594539309128621,0.444395278940334,0.295266429131225,0.147139123812707};

for(uint8_t i=0;i<CEPLENGTH;i++)
{
	posbank=positionbank[i];
	posFFT=positionFFT[i];
	for(uint8_t j=0; j<length[i];j++)
	{
			output[i]=output[i]+fftout[posFFT]*fftout[posFFT]*melbank[posbank];
			posFFT++;
			posbank++;
	}
}

//logarytmowanie
for(uint8_t i=0;i<CEPLENGTH;i++)
{
	output[i]=log(output[i]);
}
}
//DCT
//arm_dct4_f32(&D, dctState,output);

void DCT_custom(float32_t *input,float32_t *output,uint16_t length)
{
    float32_t temp;
    for(int i=0;i<length;i++)
    {
    	temp=0;
    	if(i==0)
    	{
    		for(int j=0;j<length;j++)
    		{
    			temp=temp+input[j];
    		}
    		output[i]=temp/sqrtf(length);
    	}
    	else
    	{
    		for(int j=0;j<length;j++)
    	{
    		temp=temp+(input[j]*cos((pi*i*(2*j+1))/(2*length)));
        }
    		output[i]=temp*sqrtf(2)/sqrtf(length);
    	}
    }

}
